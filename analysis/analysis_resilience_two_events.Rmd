---
title: "Analysis resilience patterns two events"
author: "AJ Perez-Luque (@ajpelu)"
date: "2017 Jan"
output:  
  md_document:
    toc: true
    variant: markdown_github
---
```{r, echo=FALSE, message=FALSE}
require(knitr)
opts_chunk$set(fig.align='center', message = FALSE, echo = FALSE, warning = FALSE) 
```



```{r}
#---------------------------------
machine <- 'ajpelu'
#machine <- 'ajpeluLap'
di <- paste('/Users/', machine, '/Dropbox/phd/phd_repos/qpyr_resilience', sep='')
#---------------------------------
```

```{r packages, warning=FALSE, message=FALSE}
source(paste0(di,"/R/exportpdf.R")) # function to export raster levelplots maps as pdf
library("dplyr")
library("ggplot2")
library("reshape2")
library("purrr")
library("pander")
library("knitr")
source("http://www.highstat.com/Book2/HighstatLibV6.R")
library("multcomp")
library("broom")
library("effects")
library("lsmeans")
library("multcompView")
library("devtools")
# multicomp table 
devtools::source_gist("194e721077ec045a2b864088908e7aca", filename = "table_glht.r")
```


```{r}
# Read resilience
evi_resilience <- read.csv(file=paste(di, "/data/evi_resilience.csv", sep=""), header = TRUE, sep = ',')

# Prepare data
elev <- read.csv(file=paste(di, "/data/elev.csv", sep=""), header = TRUE, sep = ',')


eviresi <- evi_resilience %>%  
  dplyr::inner_join(elev, by='iv_malla_modi_id') %>% 
  mutate(clu_pop = as.factor(ifelse(pop %in% c(1,2,3,4,5), 'N', 'S'))) %>% 
  mutate(clu_popf = as.factor(ifelse(clu_pop == 'N', 'Northern slope', 'Southern slope'))) %>% 
  mutate(event = as.factor(ifelse(event == 1, 2005, 2012)))
  
```


```{r}
variables <- c('dr','post', 'pre','rs','rc','rt','rrs')
myseasons <- unique(eviresi$seasonF)
auxdf <- data.frame()

for (m in myseasons){ 
  # filter by season
  aux_season <- eviresi %>% filter(seasonF == m)
  
  for (j in unique(eviresi$event)){
    # filter by event 
    auxilio <- aux_season %>% filter(event==j) 
    
    for (i in variables){ 
      aux <- auxilio %>% 
        dplyr::group_by(clu_pop) %>% 
        summarise_each_(funs(mean, sd, se=sd(.)/sqrt(n())), i) %>% 
        mutate(variable=i) %>% 
        mutate(event = j) %>% 
        mutate(seasonF = m)
      
      auxdf <- rbind(auxdf, aux)
    }
  }
}

auxdf <- auxdf %>% mutate(variable = plyr::mapvalues(variable,
                                                         c("dr","post","pre","rs","rc","rt","rrs"),
                                                         c("1_dr","2_post","0_pre","rs","rc","rt","rrs")))


label_variable <- c('rt' = 'Resistance', 
                    'rc' = 'Recovery',
                    'rs' = 'Resilience',
                    'rrs' = 'Relative Resilience',
                    '0_pre' = 'PreDrought',
                    '1_dr' = 'Drought',
                    '2_post' = 'PostDrought')
```



# Resilience 
## Mean values (Cluster population)
```{r}
mivariable <- 'rs'

auxdf %>% dplyr::filter(variable==mivariable) %>% pander(round=4, caption=paste0('Mean values (', mivariable,')'))
```

## Summer 
```{r}
# Select season 
myseason <- 'summer'
df <- eviresi %>% filter(seasonF == myseason)

# Model 
myformula <- as.formula(paste0(mivariable, " ~ event*clu_pop"))
mymodel <- aov(myformula, data=df)
```

### Summary ANOVA model
```{r}
## Summary model 
tm <- broom::tidy(mymodel)

# See http://my.ilstu.edu/~wjschne/444/ANOVA.html#(1) 
pander(tm, round=5,
       caption = paste0("ANOVA table: ", mivariable, " ", myseason), missing = '', 
       emphasize.strong.cells = which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```             

```{r} 
gm <- broom::glance(mymodel)
gm <- apply(gm, 1, formatC, digits = 2, format = "f") %>% t()
colnames(gm) <- paste0("$",c("R^2","\\mathrm{adj}R^2","\\sigma_e","F","p","df_m","\\mathrm{logLik}","AIC","BIC","\\mathrm{dev}","df_e"),"$")
rownames(gm) <- "Statistic"
pander(t(gm))
```

### Effects plot 
#### . ~ Cluster population 

```{r}
### Population 
plot(effect("clu_pop",mymodel), 
               main=paste0(myseason, ' - ', mivariable, ' vs. Cluster population'),
               xlab='Cluster population')
```

#### . ~ Disturbance Event

```{r}
### Event
plot(effect("event",mymodel), 
     main=paste0(myseason, ' - ', mivariable, ' vs. Drought event'),
     xlab='Drought event')
```

##### . ~ Cluster population:Elevation  
```{r} 
### Both 
plot(effect("event:clu_pop",mymodel), 
     main=paste0('Interaction plot (',mivariable, ') - ', myseason),
     xlab='Drought event')
```

### Post-hoc comparison 

```{r}
phc <- function(mymodel){ 
  # Event 
  ph_event <- lsmeans(mymodel, pairwise ~ event, adjust = "tukey")
  # differences letters 
  cld_event <- cld(ph_event, alpha   = 0.01, 
                   Letters = letters, 
                   adjust  = "tukey")
  
  # Clu pop  
  ph_clu <- lsmeans(mymodel, pairwise ~ clu_pop, adjust = "tukey")
  cld_clu <- cld(ph_clu, alpha   = 0.01, 
                 Letters = letters, 
                 adjust  = "tukey")

  # interaction 
  ph_i <- lsmeans(mymodel, pairwise ~ event:clu_pop, adjust = "tukey")

  # Return objects
  cat('\n### Event ###\n')
  print(ph_event)
  print(cld_event)
  cat('\n### Clu pop ###\n')
  print(ph_clu)
  print(cld_clu)
  cat('\n### Event:Clu pop ###\n')
  print(ph_i)
}

phc(mymodel = mymodel)
```


## Spring 
```{r}
# Select season 
myseason <- 'spring'
df <- eviresi %>% filter(seasonF == myseason)

# Model 
myformula <- as.formula(paste0(mivariable, " ~ event*clu_pop"))
mymodel <- aov(myformula, data=df)
```

### Summary ANOVA model
```{r}
## Summary model 
tm <- broom::tidy(mymodel)

# See http://my.ilstu.edu/~wjschne/444/ANOVA.html#(1) 
pander(tm, round=5,
       caption = paste0("ANOVA table: ", mivariable, " ", myseason), missing = '', 
       emphasize.strong.cells = which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```             

```{r} 
gm <- broom::glance(mymodel)
gm <- apply(gm, 1, formatC, digits = 2, format = "f") %>% t()
colnames(gm) <- paste0("$",c("R^2","\\mathrm{adj}R^2","\\sigma_e","F","p","df_m","\\mathrm{logLik}","AIC","BIC","\\mathrm{dev}","df_e"),"$")
rownames(gm) <- "Statistic"
pander(t(gm))
```

### Effects plot 
#### . ~ Cluster population 
```{r}
### Population 
plot(effect("clu_pop",mymodel), 
               main=paste0(myseason, ' - ', mivariable, ' vs. Cluster population'),
               xlab='Cluster population')
```

#### . ~ Disturbance Event
```{r}
### Event
plot(effect("event",mymodel), 
     main=paste0(myseason, ' - ', mivariable, ' vs. Drought event'),
     xlab='Drought event')
```

#### . ~ Cluster population:Elevation  
```{r} 
### Both 
plot(effect("event:clu_pop",mymodel), 
     main=paste0('Interaction plot (',mivariable, ') - ', myseason),
     xlab='Drought event')
```

### Post-hoc comparison 
```{r}
phc(mymodel = mymodel)
```

## Annual 
```{r}
# Select season 
myseason <- 'annual'
df <- eviresi %>% filter(seasonF == myseason)

# Model 
myformula <- as.formula(paste0(mivariable, " ~ event*clu_pop"))
mymodel <- aov(myformula, data=df)
```

### Summary ANOVA model
```{r}
## Summary model 
tm <- broom::tidy(mymodel)

# See http://my.ilstu.edu/~wjschne/444/ANOVA.html#(1) 
pander(tm, round=5,
       caption = paste0("ANOVA table: ", mivariable, " ", myseason), missing = '', 
       emphasize.strong.cells = which(tm < 0.1 & tm == tm$p.value, arr.ind = T))
```             

```{r} 
gm <- broom::glance(mymodel)
gm <- apply(gm, 1, formatC, digits = 2, format = "f") %>% t()
colnames(gm) <- paste0("$",c("R^2","\\mathrm{adj}R^2","\\sigma_e","F","p","df_m","\\mathrm{logLik}","AIC","BIC","\\mathrm{dev}","df_e"),"$")
rownames(gm) <- "Statistic"
pander(t(gm))
```

### Effects plot 
#### . ~ Cluster population 
```{r}
### Population 
plot(effect("clu_pop",mymodel), 
               main=paste0(myseason, ' - ', mivariable, ' vs. Cluster population'),
               xlab='Cluster population')
```

#### . ~ Disturbance Event
```{r}
### Event
plot(effect("event",mymodel), 
     main=paste0(myseason, ' - ', mivariable, ' vs. Drought event'),
     xlab='Drought event')
```

#### . ~ Cluster population:Elevation  
```{r} 
### Both 
plot(effect("event:clu_pop",mymodel), 
     main=paste0('Interaction plot (',mivariable, ') - ', myseason),
     xlab='Drought event')
```

### Post-hoc comparison 
```{r}
phc(mymodel = mymodel)
```



