---
title: "Explore resilience patterns"
author: "AJ Perez-Luque (@ajpelu)"
date: "2016 May"
output:  
  md_document:
    variant: markdown_github
---
# Explore resilience patterns of the different *Q. pyrenaica* patches

```{r wd, echo=FALSE}
#---------------------------------
# machine <- 'ajpelu'
machine <- 'ajpeluLap'
di <- paste('/Users/', machine, '/Dropbox/MS/MS_QUERCUS_RESI/qpyr_resilience', sep='')
#---------------------------------
```

```{r packages, warning=FALSE, message=FALSE}
library("rgdal")
library("sp")
library("raster")
library("rasterVis")
source(paste0(di,"/R/exportpdf.R")) # function to export raster levelplots maps as pdf
library("dplyr")
library("ggplot2")
library("reshape2")
library("purrr")
library("pander")
library("knitr")
```

## Read and prepare data 

```{r}
# Read data
eviresi <- read.csv(file=paste(di, "/data/evi_resilience.csv", sep=""), header = TRUE, sep = ',')
```


# Maps 

* Create raster maps (two projections: `epsg:4326` and `epsg:23030`)
* Export raster maps and stacks (see `/data/raster/`)

```{r, echo=FALSE}
# Create a spatial dataframe 
eviresi_sp <- SpatialPointsDataFrame(coords = eviresi[,c('lng','lat')], data = eviresi,
                               proj4string = CRS("+init=epsg:4326"))

# Transform 
eviresi_sp <- spTransform(eviresi_sp, CRS("+init=epsg:23030"))

# Loop to create raster map 
resilience_indicators <- c('rs','rt', 'rc', 'rrs')

for (i in resilience_indicators) { 

  aux_spatial <- eviresi_sp 
  
  # raster auxiliar 
  aux_rast <- raster(aux_spatial, resolution=250)

  # variable z
  zvar <- i

  # raster_layer 
  r_resi <- rasterize(aux_spatial, aux_rast, i, fun=mean)
  names(r_resi) <- i 
  
  # reprojected raster
  r_resi_re <- projectRaster(r_resi, crs=crs("+init=epsg:4326"))
  names(r_resi_re) <- i 
  
  # assign 
  name_raster <- paste("r_",i, sep="")
  name_raster_re <- paste("r_",i,"_re", sep="")
  
  assign(name_raster, r_resi)
  assign(name_raster_re, r_resi_re)
  
  
  writeRaster(r_resi, file=paste(di, "/data/raster/r_", i, ".asc", sep=""), overwrite=TRUE)
  writeRaster(r_resi_re, file=paste(di, "/data/raster/r_", i, "_re", ".tif", sep=""), overwrite=TRUE)
  
  }


# Create stack of raster 
stack_resi <- stack(r_rc, r_rs, r_rt, r_rrs) 
stack_resi_re <- stack(r_rc_re, r_rs_re, r_rt_re, r_rrs_re)

# Export stack 
temp <- getwd()
setwd(paste(di, "/data/raster/", sep=""))
writeRaster(stack_resi, filename = 'r_resi_stack', overwrite =TRUE) 
writeRaster(stack_resi_re, filename = 'r_resi_re_stack', overwrite =TRUE) 
setwd(temp)
```


## Spatial exploration of the resilience components 

### Resilience
```{r, echo=FALSE, fig.cap='Resilience', fig.height=7, fig.width=10}
# Resilience 

# Select a palette http://colorbrewer2.org/
mypal <- brewer.pal(9, "RdYlGn")
# Specify the color palette
myTheme=rasterTheme(region=mypal)

lp <- levelplot(stack_resi_re, 
          margin=FALSE,
          layer='rs', 
          par.settings=myTheme,
          pretty=TRUE,
          main='Resilience (rs)', xlab=NULL, ylab=NULL)

print(lp)

exportpdf(mypdf=paste0(di, '/man/images/raster_rs.pdf'), lp) 
```

### Resistance 
```{r, echo=FALSE, fig.cap='Resistance', fig.height=7, fig.width=10}
# Resistance  

# Select a palette http://colorbrewer2.org/
mypal <- brewer.pal(9, "RdYlGn")
# Specify the color palette
myTheme=rasterTheme(region=mypal)

lp <- levelplot(stack_resi_re, 
          margin=FALSE,
          layer='rt', 
          par.settings=myTheme,
          pretty=TRUE,
          main='Resistance (rt)', xlab=NULL, ylab=NULL)

print(lp)

exportpdf(mypdf=paste0(di, '/man/images/raster_rt.pdf'), lp) 
```


### Recovery 
```{r, echo=FALSE, fig.cap='Recovery', fig.height=7, fig.width=10}
# Recovery 

# Select a palette http://colorbrewer2.org/
mypal <- brewer.pal(9, "RdYlGn")
# Specify the color palette
myTheme=rasterTheme(region=mypal)

lp <- levelplot(stack_resi_re, 
          margin=FALSE,
          layer='rc', 
          par.settings=myTheme, 
          pretty=TRUE,
          main='Recovery (rc)', xlab=NULL, ylab=NULL)

print(lp)

exportpdf(mypdf=paste0(di, '/man/images/raster_rc.pdf'), lp) 
```


### Relative Resilience
```{r, echo=FALSE, fig.cap='Relative Resilience', fig.height=7, fig.width=10}
# Relative Resilience 

# Select a palette http://colorbrewer2.org/
mypal <- brewer.pal(9, "RdYlGn")
# Specify the color palette
myTheme=rasterTheme(region=mypal)

lp <- levelplot(stack_resi_re, 
          margin=FALSE,
          layer='rrs', 
          par.settings=myTheme,
          pretty=TRUE,
          main='Relative Resilience (rs)', xlab=NULL, ylab=NULL)

print(lp)

exportpdf(mypdf=paste0(di, '/man/images/raster_rrs.pdf'), lp) 
```



# Elevation pattern 

* We remove population `Cadiar`

```{r}
# Prepare data
elev <- read.csv(file=paste(di, "/data/elev.csv", sep=""), header = TRUE, sep = ',')

eviresi <- eviresi %>% 
  # join elevation data
  dplyr::inner_join(elev, by='iv_malla_modi_id') %>% 
  # Add a variable for population cluster
  mutate(clu_pop = ifelse(poblacion == 1, 'a', 
                          ifelse(poblacion %in% c(2,3,4,5), 'b', 
                                 ifelse(poblacion %in% c(6,7,8), 'c', 'out'))))

# Filter out cluster 
eviresi_f <- eviresi %>% filter(clu_pop != 'out')
```

## Explore elevation pattern general and by cluster of populations

```{r}
# Change format of the dataset (wide to long)
df_melt <- melt(eviresi_f, id.vars = c('iv_malla_modi_id', 'poblacion',
                                      'lng', 'lat', 'elev', 'clu_pop'))

df_aux <- df_melt %>% filter(variable %in% c('rs','rt','rc', 'rrs'))

  
label_variable <- c('rt' = 'Resistance', 
                    'rc' = 'Recovery',
                    'rs' = 'Resilience',
                    'rrs' = 'Relative Resilience')
label_cluster <- c('a' = 'Camarate',
                   'b' = 'Northern slope',
                   'c' = 'Southern slope')
```

### General pattern 
```{r, fig.cap='Resilience components vs. elevation', fig.width=12, fig.height=8}

g <- ggplot(df_aux[df_aux$variable != 'rrs',], aes(x=elev, y=value)) + 
  geom_point(col='gray') + 
  geom_smooth(method = 'lm') + 
  facet_wrap(~variable, nrow=1, labeller = as_labeller(label_variable)) + 
  theme_bw() + 
  theme(strip.background = element_rect(fill = "white")) 

g
pdf(file=paste0(di, "/man/images/plot_resicomp_elev.pdf"), height = 5, width = 8)
g
dev.off() 
```


```{r, fig.cap='Relative Resilience vs. elevation'}
gr <- ggplot(df_aux[df_aux$variable == 'rrs',], aes(x=elev, y=value)) + 
  geom_point(col='gray') + 
  theme_bw() +
  geom_smooth(method = 'lm') + 
  ggtitle('Relative Resilience')

gr

pdf(file=paste0(di, "/man/images/plot_resi_rel_elev.pdf"), height = 5, width = 5)
gr
dev.off() 
```


### Elevational pattern by population 
```{r, fig.cap='Resilience components vs. elevation (grouped by cluster) ', fig.width=12, fig.height=10}

gp <- ggplot(df_aux[df_aux$variable != 'rrs',], aes(x=elev, y=value)) +
  geom_point(col='gray') + 
  geom_smooth(method = 'lm') + 
  facet_grid(variable ~clu_pop, scales = 'free_y',
             labeller = labeller(.rows = label_variable,
                                 .cols = label_cluster)) +
  # facet_wrap(~variable, labeller = as_labeller(label_variable)) + 
  theme_bw() + 
  theme(strip.background = element_rect(fill = "white")) 
gp 

pdf(file=paste0(di, "/man/images/plot_resicomp_elev_grouped.pdf"), height = 8, width = 8)
gp
dev.off() 
```



```{r, fig.cap='Relative resilience vs. elevation (grouped by cluster) ', fig.width=12, fig.height=7}

gpr <- ggplot(df_aux[df_aux$variable == 'rrs',], aes(x=elev, y=value)) +
  geom_point(col='gray') + 
  geom_smooth(method = 'lm') + 
  facet_wrap(~clu_pop, labeller = as_labeller(label_cluster)) +
  theme_bw() + 
  theme(strip.background = element_rect(fill = "white")) 
gpr 

pdf(file=paste0(di, "/man/images/plot_resi_rel_elev_grouped.pdf"), height = 6, width = 12)
gpr
dev.off()
```


# Explore pattern by population (cluster)
```{r, fig.cap='Resilience components by cluster (populations)', fig.width=8, fig.height=8}
gpop <- ggplot(df_aux, aes(x=clu_pop, y=value)) + 
  geom_boxplot() + 
  facet_wrap(~variable, scales = 'free_y', labeller = as_labeller(label_variable)) + 
  theme_bw() + xlab('')+
  theme(strip.background = element_rect(fill = "white")) +  
  scale_x_discrete(labels = label_cluster)

gpop
pdf(file=paste0(di, "/man/images/plot_resicomp_by_cluster.pdf"), height = 7, width = 8)
gpop
dev.off()
```


# Exploring relationships 

```{r}
# https://cran.r-project.org/web/packages/broom/vignettes/broom_and_dplyr.html

# Regresssion models resilience component ~ elevation by cluster pop 

# 'rs' 
myformula <- as.formula(rs ~ elev) 

# Get coef
reg_coef_rs <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>% broom::tidy(fit) %>% mutate(variable = 'rs')
# Get stat regression
reg_summ_rs <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>%  broom::glance(fit) %>% mutate(variable = 'rs')


# 'rt' 
myformula <- as.formula(rt ~ elev) 

# Get coef
reg_coef_rt <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>% broom::tidy(fit) %>% mutate(variable = 'rt')
# Get stat regression
reg_summ_rt <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>%  broom::glance(fit) %>% mutate(variable = 'rt')


# 'rc' 
myformula <- as.formula(rc ~ elev) 

# Get coef
reg_coef_rc <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>% broom::tidy(fit) %>% mutate(variable = 'rc')
# Get stat regression
reg_summ_rc <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>%  broom::glance(fit) %>% mutate(variable = 'rc')


# 'rrs' 
myformula <- as.formula(rrs ~ elev) 

# Get coef
reg_coef_rrs <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>% broom::tidy(fit) %>% mutate(variable = 'rrs')
# Get stat regression
reg_summ_rrs <- eviresi_f %>% dplyr::group_by(clu_pop) %>%
    do(fit = lm(myformula, data =.)) %>%  broom::glance(fit) %>% mutate(variable = 'rrs')



# Create table with all regressions output 

reg_coef <- rbind(reg_coef_rs, reg_coef_rt, reg_coef_rc, reg_coef_rrs)
reg_summ <- rbind(reg_summ_rs, reg_summ_rt, reg_summ_rc, reg_summ_rrs)

pandoc.table(reg_coef, caption = "Coefficients of Regression")

kable(reg_coef, caption = "Coefficients of Regression")

kable(reg_summ, caption = "Coefficients of Regression")
```



```{r, echo=FALSE, eval=FALSE} 
m <- eviresi_f %>% 
  split(.$clu_pop) %>% 
  map(~ lm(rs ~ elev, data =.)) %>% 
  map(broom::tidy) 

mm <- m %>% unlist()
  
  flatten(.)

eviresi_f %>% 
  slice_rows("clu_pop") %>% 
  map(~ lm(rs ~ elev, data =.)) 

%>% 
  map(broom::tidy)


mtcars %>%
  slice_rows("cyl") %>%
  by_slice(partial(lm, mpg ~ disp), .labels = FALSE) %>%
  map(coef)


%>%
  # map_dbl(c("r.squared")) 
  map_dbl(c(2, 1))
```







